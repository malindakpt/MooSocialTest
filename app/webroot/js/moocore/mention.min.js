(function(h,A){"function"===typeof define&&define.amd?define(["jquery","overlay","textcomplete","bloodhound"],A):"object"===typeof exports?module.exports=A(require("jquery")):h.mooMention=A()})(this,function(h){function A(a,f){var e=String(a.data.obj.value),d=h(a.data.mirrorCheckSpell).html();if(e!=d){var c;a:{c=e.split(/(\s+)/);for(var g=d.split(/(\s+)/),r=index=0;r<c.length;r++){if(c[r]!=g[r]){c={beforeChanged:g[r],afterChanged:c[r],index:index};break a}index+=g[r].length}c=void 0}e.split("");d.split("");
d=c.beforeChanged;g=c.afterChanged;if(void 0!=d&&void 0!=g){if(d.length<g.length&&(rangeSpell=g.length-d.length,0<Object.keys(b).length))for(var k in b)b.hasOwnProperty(k)&&b[k].start>c.index&&(b[k].start+=rangeSpell,b[k].end+=rangeSpell);if(d.length>g.length&&(rangeSpell=d.length-g.length,0<Object.keys(b).length))for(k in b)b.hasOwnProperty(k)&&b[k].start>c.index&&(b[k].start-=rangeSpell,b[k].end-=rangeSpell)}h(a.data.mirrorCheckSpell).html(e);k=a.data.mirror;var d=[],m,e=e.split("");c="";if(0<Object.keys(b).length){g=
0;for(m in b)b.hasOwnProperty(m)&&(d[g]=b[m],d[g].key=m,g++);for(g=0;g<d.length-1;g++)for(j=g+1;j<d.length;j++)d[g].start>d[j].start&&(m=d[j],d[j]=d[g],d[g]=m)}for(g=0;g<e.length;g++){m=!1;if(0<d.length)for(j=0;j<d.length;j++)g==d[j].start&&(c+="@["+d[j].key+":"+e[g],m=!0),g==d[j].end&&(c+="]"+e[g],m=!0);m||(c+=e[g])}for(j=0;j<d.length;j++)d[j].end==e.length&&(c+="]");k.value=c;w(h(a.data.obj))}}var F,G,B={},y=[],x,K,H,b={},C={},L={},M=!1,z=[];h("body").on("focus","textarea",function(){var a=h(this).siblings("input.messageHidden");
0<a.length&&(D(h(this)),N(a.val(),h(this)))});h("body").on("keydown",function(a){a.stopPropagation();if(116==a.which){var b=h("textarea");h.each(b,function(b,d){if(""!=h(d).val())return a.preventDefault(),window.confirm("This page is asking you to confirm that you want to leave - data you have entered may not be saved.")&&(h("textarea").val(""),h(".messageHidden").val(""),window.location.reload()),!1})}});var P=function(a,f){h("#"+f).destroyOverlayInstance(h("#"+f));h("#"+f).textcomplete([{mentions:a,
match:/\B@(.+)$/,search:function(a,b){K=a.length;b(h.map(this.mentions,function(b,e){if(-1!=y.indexOf(e))return null;var c;a:{c=a.toLowerCase();var d="\\()[]^{}*+?$.".split(""),f;for(f in d)if(d.hasOwnProperty(f)&&-1!=c.indexOf(d[f])){c=!0;break a}c=!1}if(c)return null;c=new RegExp("\\b"+a.toLowerCase(),"g");if(b)return b.toLowerCase().match(c)?e:null}))},template:function(a){return'<img src="'+L[a]+'" class="user_avatar_small" /> '+B[a]},index:1,replace:function(a){return B[a]}}],{appendTo:"body",
zIndex:1055}).overlay([{match:{},css:{"background-color":"#CAD8F4"}}]).on({"textComplete:select":function(a,d,c){a=B[d];for(var e in B)if(d==e){c=h(this).prop("selectionStart")-a.length+1;var f,k=c,m=void 0;f={};if(0<Object.keys(b).length){var p=void 0;for(p in b)b.hasOwnProperty(p)&&k>=b[p].end&&(k+=replaceLength[p].length-b[p].length,m+=replaceLength[p].length-b[p].length)}f.start=k;f.end=m;var v=e,k=a,m=h(this);f=f.start;var p=K,n=m.siblings(".messageHidden"),q=n.val(),u="["+v+":"+k+"]",l=q.substring(0,
f),t=q.substring(f),t=t.replace(q.substring(f,f+p),u);n.val(l+t);m.siblings(".checkSpell").html(m.val());replaceLength[v]={start:f-1,end:f+u.length,length:u.length+1};v=u.length+1;if(0<Object.keys(b).length)for(n in n=void 0,b)b.hasOwnProperty(n)&&f-1<=b[n].start&&(replaceLength[n].start=replaceLength[n].start-(p+1)+v,replaceLength[n].end=replaceLength[n].end-(p+1)+v,b[n].start=b[n].start-(p+1)+k.length,b[n].end=b[n].end-(p+1)+k.length);w(m);y.push(e);--c;b[e]={start:c,end:h(this).prop("selectionStart"),
length:h(this).prop("selectionStart")-c};w(h(this),!0)}}});0==h("#"+f).siblings("input.messageHidden").length&&("edit_activity"==H?h("#"+f).after('<input type="hidden" id="'+f+'_hidden" name="data[message]" class="messageHidden" /><div class="checkSpell" style="display: none"></div>'):h("#"+f).after('<input type="hidden" name="data[message]" class="messageHidden" /><div class="checkSpell" style="display: none"></div>'));x=h("#"+f).siblings(".messageHidden")[0];mirrorCheckSpell=jQuery("#"+f).siblings(".checkSpell")[0];
"edit_activity"==H&&(x.value=G);h("#"+f).on("keypress keydown",{obj:jQuery("#"+f)[0],mirror:x,mirrorCheckSpell:mirrorCheckSpell},O);h("#"+f).bind("input",{obj:jQuery("#"+f)[0],mirror:x,mirrorCheckSpell:mirrorCheckSpell},A);h("#"+f).on("paste",{obj:jQuery("#"+f)[0],mirror:x,mirrorCheckSpell:mirrorCheckSpell},V);h("#"+f).on("cut",{obj:jQuery("#"+f)[0],mirror:x,mirrorCheckSpell:mirrorCheckSpell},W)},N=function(a,f){var e=0,d=0;D(f);var c=a.replace(/@\[(\d+):([^\]]+)\]/g,function(c,f,h){y.push(f);replaceLength[f]=
{start:a.indexOf(c),end:a.indexOf(c)+c.length,length:c.length};var g=a.indexOf(c)-e+d;b[f]={start:g,end:g+h.length,length:h.length};e+=c.length;d+=h.length;return h});f.val(c);w(f)},O=function(a,f){if(X(a)||"undefined"!=typeof f){var e=h(a.data.obj).prop("selectionStart"),d=e,c=h(a.data.obj).prop("selectionEnd"),g=c,r=String(a.data.mirror.value),k=String(a.data.obj.value),m=!1,p,v,n,q=0;if(0<Object.keys(b).length){var u=!1,l;for(l in b){if(u&&!m)break;if(b.hasOwnProperty(l)){if(d>=b[l].end)e=t(d),
c=t(d,g),d==b[l].end&&"keydown"==a.type&&8==a.which&&d==g&&(a.preventDefault(),d=Q(d-1,k,l),q=g-d,E(a,k,d,g),c=R(l,e,c,d,g),e=c.selectionStart,c=c.selectionEnd,u=!0);else{if(g>b[l].start&&d<b[l].start||g>b[l].end&&d<b[l].end){c=String(a.data.obj.value);e=t(d);r=S(e,c,r,d);e=c.substring(g);m=13==a.which?"\\n":32==a.which?" ":"keydown"!=a.type||46!=a.which&&8!=a.which?"undefined"==typeof f||"cut"!=a.type&&"delete"!=a.type?String.fromCharCode(a.which):"":"";a.data.mirror.value=r+m+e;I(l,d);jQuery(a.data.mirrorCheckSpell).html(k.substring(0,
d)+m+k.substring(g));w(h(a.data.obj));return}if(d==b[l].start||d==b[l].start&&g==b[l].end){if(d!=g||d==g&&"keydown"==a.type&&46==a.which)a.preventDefault(),u=0,d!=g&&8==a.which?u=1:46==a.which&&(u=1),t(d),t(d,g),g=T(d,k,l),c=g<b[l].end?1:0,g==b[l].end&&a.preventDefault(),u=g<b[l].end?u:0,q=g-d,e=replaceLength[l].end-b[l].length-1,c=e+q+c,g+=u,E(a,k,d,g),U(e,c,l),u=!0}else if(b[l].start<d&&b[l].end>d){if("keydown"==a.type&&46==a.which||8==a.which)a.preventDefault(),e=t(d),c=t(d,g),d==g&&(8==a.which&&
d>b[l].start?(g--,d--):46==a.which&&g<b[l].end&&(g++,d++),d>b[l].start&&d--),d=Q(d,k,l),g=T(g,k,l),g+=g<b[l].end&&d==b[l].start?1:0,q=g-d,E(a,k,d,g),c=R(l,e,c,d,g),e=c.selectionStart,c=c.selectionEnd;else{c=String(a.data.obj.value);r=r.substring(0,replaceLength[l].start);r+=c.substring(b[l].start,d);e=c.substring(g);m=13==a.which?"\\n":32==a.which?" ":"keydown"==a.type&&46==a.which||8==a.which?"":"undefined"==typeof f||"cut"!=a.type&&"delete"!=a.type?String.fromCharCode(a.which):"";a.data.mirror.value=
r+m+e;I(l,d);jQuery(a.data.mirrorCheckSpell).html(k.substring(0,d)+m+k.substring(g));w(h(a.data.obj));return}u=!0}}if(0==b[l].length){var e=replaceLength[l].start,c=replaceLength[l].end+q,x;for(x in y)y[x]==l&&y.splice(x,1);delete replaceLength[l];delete b[l];J(e,c,a,p);E(a,k,d,g);w(h(a.data.obj));v=e;n=c;p=q;m=!0;break}}}}m||("undefined"!=typeof v&&"undefined"!=typeof p?J(v,n,a,p):J(d,g,a));13==a.which?m="\n":32==a.which?m=" ":"keydown"!=a.type||46!=a.which&&8!=a.which?m="undefined"==typeof f||"cut"!=
a.type&&"delete"!=a.type?String.fromCharCode(a.which):"":(m="",e==c&&(8==a.which?--e:46==a.which&&(c+=1)),d==g&&(8==a.which?--d:46==a.which&&(g+=1)));l=r.substring(0,e);r=r.substring(c);a.data.mirror.value=l+m+r;jQuery(a.data.mirrorCheckSpell).html(k.substring(0,d)+m+k.substring(g));w(h(a.data.obj))}},V=function(a){var f=h(a.data.obj).prop("selectionStart"),e=f,d=h(a.data.obj).prop("selectionEnd"),c=d,g="",r,k=String(a.data.mirror.value),m=String(a.data.obj.value);setTimeout(function(){var p=String(a.data.obj.value),
v=h(a.data.obj).prop("selectionStart");h(a.data.obj).prop("selectionEnd");r=v-e-(c-e);g=p.substring(e,v);if(0<Object.keys(b).length)for(var n in b)if(b.hasOwnProperty(n))if(e==c&&(e<=b[n].start||c>=b[n].end))f=t(e),d=t(e,c);else{f=t(e);var q=S(f,p,k,e),p=p.substring(v);a.data.mirror.value=q+g+p;I(n,e);jQuery(a.data.mirrorCheckSpell).html(m.substring(0,e)+g+m.substring(c));return}n=r;if(0<Object.keys(b).length)for(q in b)b.hasOwnProperty(q)&&e<=b[q].start&&(replaceLength[q].start+=n,replaceLength[q].end+=
n,b[q].start+=n,b[q].end+=n);n=k.substring(0,f);p=k.substring(d,k.length);k=n+g+p;a.data.mirror.value=k;jQuery(a.data.mirrorCheckSpell).html(m.substring(0,e)+g+m.substring(c))},10)},W=function(a){O(a,!0)},Y=function(a){var b=a.data.obj,e=a.data.mirror;setTimeout(function(){e.value=String(b.value);D(h(b))},10)},U=function(a,f,e){0<Object.keys(b).length&&(a=0==f-a?1:f-a,replaceLength[e].end-=a,replaceLength[e].length-=a,b[e].end-=a,b[e].length-=a)},X=function(a){var f=a.which;if("keypress"==a.type&&
8!=f)return 0!=f?a.ctrlKey?(!a.ctrlKey||90!=f&&89!=f||Y(a),!1):"none"!=h('ul[id^="textcomplete-dropdown"]').css("display")&&13==f?!1:!0:!1;if("keydown"==a.type){if(46==f||8==f)return!0;if(116==f)0<Object.keys(b).length&&(a.preventDefault(),a.stopPropagation(),window.confirm("This page is asking you to confirm that you want to leave - data you have entered may not be saved.")&&(h("textarea").val(""),h(".messageHidden").val(""),window.location.reload()));else return!1}},J=function(a,f,e,d){if(0<Object.keys(b).length)for(var c in b)b.hasOwnProperty(c)&&
(a<b[c].start&&(8!=e.which||0!=a||0!=f)?"keydown"==e.type&&(46==e.which||8==e.which)||"cut"==e.type?(replaceLength[c].start-=f==a?1:f-a,replaceLength[c].end-=f==a?1:f-a,"undefined"==typeof d||0==d?(b[c].start-=f==a?1:f-a,b[c].end-=f==a?1:f-a):(b[c].start-=d,b[c].end-=d)):(replaceLength[c].start=replaceLength[c].start-(f-a)+1,replaceLength[c].end=replaceLength[c].end-(f-a)+1,"undefined"==typeof d||0==d?(b[c].start=b[c].start-(f-a)+1,b[c].end=b[c].end-(f-a)+1):(b[c].start=b[c].start-d+1,b[c].end=b[c].end-
d+1)):a==b[c].start&&("keydown"!=e.type||46!=e.which&&8!=e.which)?(replaceLength[c].start=replaceLength[c].start-(f-a)+1,replaceLength[c].end=replaceLength[c].end-(f-a)+1,"undefined"==typeof d||0==d?(b[c].start=b[c].start-(f-a)+1,b[c].end=b[c].end-(f-a)+1):(b[c].start=b[c].start-d+1,b[c].end=b[c].end-d+1)):a==b[c].start&&8==e.which&&0<replaceLength[c].start&&0<b[c].start&&a==f!=0&&(replaceLength[c].start--,replaceLength[c].end--,b[c].start--,b[c].end--))},I=function(a,f){for(var e in b)b.hasOwnProperty(e)&&
"undefined"!=typeof f&&b[e].start<=f&&b[e].end>f&&(a=e);var d=b[a].start,c={},g={},h=[];for(e in b)b.hasOwnProperty(e)&&b[e].start<d&&(c[e]=b[e],g[e]=replaceLength[e],h.push(e));b=c;replaceLength=g;y=h},t=function(a,f){var e=a,d=f,c;for(c in b)b.hasOwnProperty(c)&&b[c].end<=a&&("undefined"==typeof f?e+=replaceLength[c].length-b[c].length:d+=replaceLength[c].length-b[c].length);return"undefined"==typeof f?e:d},S=function(a,f,e,d){var c="",g;for(g in b)b.hasOwnProperty(g)&&a>replaceLength[g].start&&
a<replaceLength[g].end&&(a=replaceLength[g].start,c=f.substring(b[g].start,d));return e.substring(0,a)+c},D=function(a){b={};replaceLength={};y=[];w(a)},w=function(a,f){F=a.getInstanceOverlay(a);a.revokeOverlay([{match:b}],F);a.reRenderTextOnOverlay(F)},Q=function(a,f,e){for(var d=f.substr(a,1);" "!=d&&a>b[e].start;d=f.substr(a,1))a--;return a},T=function(a,f,e){for(var d=f.substr(a,1);" "!=d&&a<b[e].end;d=f.substr(a,1))a++;return a},R=function(a,f,e,d,c){f=t(d);e=t(d,c);e-=replaceLength[a].start;
f-=replaceLength[a].start;e=b[a].length-e;f=b[a].length-f;f=replaceLength[a].end-f-1;e=replaceLength[a].end-e-1;U(f,e,a);return{selectionStart:f,selectionEnd:e}},E=function(a,b,e,d){var c=b.substring(0,e);b=b.substring(d);a.data.obj.value=c+b;a=a.data.obj;a.setSelectionRange?(a.focus(),a.setSelectionRange(e,e)):a.createTextRange&&(a=a.createTextRange(),a.collapse(!0),a.moveEnd("character",e),a.moveStart("character",e),a.select())};return{init:function(a,b){H=b;switch(b){case "edit_activity":G=h("#"+
a).val(),N(G,h("#"+a))}-1==h.inArray(a,z)&&(0==Object.keys(C).length?M?z.push(a):(M=!0,z.push(a),(new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.name)},queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:mooConfig.url.base+"/users/friends.json",cache:!1,filter:function(a){h.each(a.data,function(a,b){C[b.id]=b.name;B[b.id]=b.name;L[b.id]=b.avatar});for(i=0;i<z.length;i++)P(C,z[i]);z=[];return h.map(a.data,function(a){return a})}},identify:function(a){return a.id}})).initialize()):
P(C,a))},resetMention:function(a){a.siblings("input.messageHidden").val("");a.siblings("div.textoverlay").html("");D(a)},reConfigOverlay:w}});